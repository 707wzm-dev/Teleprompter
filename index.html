<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Teleprompter Ultra-Realtime</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">

    <style>
        body { margin: 0; background: black; color: white; font-family: sans-serif; overflow: hidden; }
        #viewport { 
            height: 100vh; overflow-y: scroll; 
            display: flex; flex-direction: column; align-items: center; 
            scroll-behavior: smooth; /* Movimiento suave de seda */
        }
        #viewport::-webkit-scrollbar { display: none; }
        #margin-box { width: 85%; padding-top: 45vh; padding-bottom: 85vh; }
        #text { 
            width: 100%; font-size: 44px; line-height: 1.5; 
            outline: none; white-space: pre-wrap; color: #eee;
        }
        #guide { 
            position: fixed; top: 50%; left: 0; width: 100%; height: 2px; 
            background: #0f0; opacity: 0.5; pointer-events: none; z-index: 10;
        }
        #controls { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; 
            background: rgba(20,20,20,0.95); padding: 15px; border-radius: 25px; 
            width: 90%; max-width: 500px; border: 1px solid #333;
        }
        button { background: #333; color: white; border: none; padding: 15px 5px; border-radius: 15px; font-size: 18px; }
        .active { background: #d32f2f !important; box-shadow: 0 0 15px red; }
        .btn-large { grid-column: span 2; font-weight: bold; }
        .mirror { transform: scaleX(-1); }
    </style>
</head>
<body>
    <div id="guide"></div>
    <div id="viewport">
        <div id="margin-box"><div id="text" contenteditable="true">Pega tu guion aqu√≠. Lee con naturalidad y ver√°s que el texto se mueve INSTANT√ÅNEAMENTE con cada s√≠laba.</div></div>
    </div>
    <div id="controls">
        <button id="micBtn" class="btn-large">üéôÔ∏è VOZ</button>
        <button id="mirrorBtn">ü™û</button>
        <button id="plusBtn">A+</button>
        <button id="minusBtn">A-</button>
        <button id="mPlus">‚ÜîÔ∏è+</button>
        <button id="mMinus">‚ÜîÔ∏è-</button>
        <button id="leftBtn">‚¨ÖÔ∏è</button>
        <button id="centerBtn">‚¨ÜÔ∏è</button>
        <button id="rightBtn">‚û°Ô∏è</button>
        <button id="resetBtn">üîÑ</button>
    </div>

    <script>
        const viewport = document.getElementById("viewport"), textElem = document.getElementById("text"), micBtn = document.getElementById("micBtn");
        let isListening = false, recognition, lastFoundIndex = 0, maxScroll = 0;

        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SR) {
            recognition = new SR();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true; // ESTO ES LA CLAVE DEL TIEMPO REAL

            recognition.onresult = (event) => {
                let transcript = "";
                // Procesamos todos los resultados, incluidos los que a√∫n no son finales
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                const palabras = transcript.toLowerCase().trim().split(" ");
                // Analizamos las √∫ltimas 3 palabras detectadas para m√°xima precisi√≥n en el avance
                const fragmento = palabras.slice(-3);
                
                fragmento.forEach(palabra => {
                    const contenido = textElem.innerText.toLowerCase();
                    const index = contenido.indexOf(palabra, lastFoundIndex);

                    if (index !== -1) {
                        lastFoundIndex = index;
                        const range = document.createRange();
                        const walker = document.createTreeWalker(textElem, NodeFilter.SHOW_TEXT, null, false);
                        let node, count = 0;

                        while (node = walker.nextNode()) {
                            let nextCount = count + node.textContent.length;
                            if (index >= count && index < nextCount) {
                                try {
                                    range.setStart(node, index - count);
                                    range.setEnd(node, index - count + palabra.length);
                                    const rect = range.getBoundingClientRect();
                                    const targetPos = viewport.scrollTop + rect.top - (window.innerHeight / 2);

                                    // Avanzar solo si es hacia adelante
                                    if (targetPos > maxScroll) {
                                        maxScroll = targetPos;
                                        viewport.scrollTo({ top: targetPos, behavior: 'smooth' });
                                    }
                                } catch(e) {}
                                break;
                            }
                            count = nextCount;
                        }
                    }
                });
            };

            recognition.onend = () => { if (isListening) recognition.start(); };
        }

        micBtn.onclick = () => {
            if (!isListening) {
                isListening = true;
                micBtn.classList.add("active");
                micBtn.innerHTML = "üõë STOP";
                textElem.contentEditable = "false";
                maxScroll = viewport.scrollTop;
                recognition.start();
            } else {
                isListening = false;
                micBtn.classList.remove("active");
                micBtn.innerHTML = "üéôÔ∏è VOZ";
                textElem.contentEditable = "true";
                recognition.stop();
            }
        };

        // Otros controles
        document.getElementById("mirrorBtn").onclick = () => textElem.classList.toggle("mirror");
        document.getElementById("plusBtn").onclick = () => textElem.style.fontSize = (parseInt(window.getComputedStyle(textElem).fontSize) + 4) + "px";
        document.getElementById("minusBtn").onclick = () => textElem.style.fontSize = (parseInt(window.getComputedStyle(textElem).fontSize) - 4) + "px";
        document.getElementById("resetBtn").onclick = () => { viewport.scrollTo({top:0}); lastFoundIndex = 0; maxScroll = 0; };
    </script>
</body>
</html>
